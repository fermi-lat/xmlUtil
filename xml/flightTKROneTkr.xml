<!-- $Header$ -->
<!-- Definition of one tower's worth of tracker for flight instrument -->

<!-- Tracker stuff.  The tracker consists of trays.  Alternate trays
     are rotated by 90 degrees with just vacuum inbetween.  But
     the rotation is not apparent to the simulator since it
     doesn't know about individual strips  -->
<!-- Trays come in 3 flavors: top tray, bottom tray and middle tray.
     These are further subdivided by thickness of converter layer which
     may be any of 
          no converter (bottom and middle trays only)
          super-GLAST thickness (middle only)
          "normal" thickness (middle and top only)  -->
    <box name="convReg" 
	 XREF="TKRTrayWidth" 
	 YREF="TKRTrayWidth" 
	 ZREF="convThickReg"
	 materialREF="convMat" />
    <box name="convSuper" 
	 XREF="TKRTrayWidth" 
	 YREF="TKRTrayWidth"
	 ZREF="convThickSup" 
	 materialREF="convMat" />
    <box name="TKRCoreReg"
	 XREF="TKRTrayWidth" 
	 YREF="TKRTrayWidth" 
	 ZREF="coreThick" 
	 materialREF="coreMat" />
    <box name="TKRCoreBottom" 
	 XREF="TKRTrayWidth" 
	 YREF="TKRTrayWidth"
	 ZREF="coreThickBottom" materialREF="coreMat" />
    <!-- box name="TKRCoreNoConv" 
	 XREF="TKRTrayWidth" 
	 YREF="TKRTrayWidth"
	 ZREF="panelThick" materialREF="coreMat" /   -->

<!-- Instead of defining a silicon box, should perhaps make
     a composition or stack(s) defining internal structure
     of ladders and strips.
  -->
    <box name="SiLayerBox"
         sensitive="true"  
	 XREF="TKRTrayWidth" 
	 YREF="TKRTrayWidth"
	 ZREF="SiThick" materialREF="TKRDetMat" />

    <choice name="SiLayer" >  
      <case mode="propagate" volume="SiLayerBox" />
      <case mode="digi recon" volume="SiLayerComp" />
    </choice>

  <!-- No explicit material, so vacuum -->
    <box name="SiLayerEnv"    
      XREF="TKRTrayWidth"
      YREF="TKRTrayWidth"
      ZREF="SiThick" 
      materialREF="vacuumMat"/>

<!-- The unrotated wafer is segmented along the x axis, hence measures X,
     hence is an X layer -->
    <box name="SiWaferActive"
         sensitive="true"
	 XREF="SiWaferActiveSide"
	 YREF="SiWaferActiveSide"
	 ZREF="SiThick"
	 materialREF="TKRDetMat">
      <seg axis="X" reason="readout" nSegREF="stripPerWafer" />
    </box>

    <box name="SiWafer"
	 XREF="SiWaferSide"
	 YREF="SiWaferSide"
	 ZREF="SiThick"
	 materialREF="TKRDetMat">
    </box>

    <composition name="SiWaferNest" envelope="SiWafer">
      <posXYZ volume="SiWaferActive" />
    </composition>
    
<!-- identify wafers by their position along stack in direction
     of measurement.                                          
     strip id in glastsim style is then 
           local(in wafer)-strip# + strips-per-wafer * wafer-id
 -->
    <stackX name="waferRow" origin="atCentre" >
      <axisMPos volume="SiWaferNest" ncopyREF="nWaferAcross">
        <idField name="fLadder" value="0" step="1" />
      </axisMPos>
    </stackX>

    <stackY name="towerLayerWafers" origin="atCentre" >
      <axisMPos volume="waferRow" ncopyREF="nWaferAcross"/>
    </stackY>

<!-- The collection of wafers is centered in the volume -->
    <composition name="SiLayerComp" envelope="SiLayerEnv">
      <posXYZ volume="towerLayerWafers" />
    </composition>

<!-- actually includes all inactive materials except core, conv -->
    <box name="TKRFaceUpperReg"  
	 XREF="faceWidth" 
	 YREF="faceWidth" 
	 ZREF="inactiveThickUpperReg" materialREF="TKRFaceMat" />
    <box name="TKRFaceUpperSuper"  
	 XREF="faceWidth" 
	 YREF="faceWidth" 
	 ZREF="inactiveThickUpperSuper" materialREF="TKRFaceMat" />

    <box name="TKRFaceLowerNoCnv"  
	 XREF="faceWidth" 
	 YREF="faceWidth" 
	 ZREF="inactiveThickLowerNoCnv" materialREF="TKRFaceMat" />

    <box name="TKRBelowCnv"  
	 XREF="faceWidth" 
	 YREF="faceWidth" 
	 ZREF="inactiveThickBelowCnv" materialREF="TKRFaceMat" />

    <box name="TKRFaceToCnvSuper"  
	 XREF="faceWidth" 
	 YREF="faceWidth" 
	 ZREF="inactiveThickToCnvSuper" materialREF="TKRFaceMat" />

    <box name="TKRFaceToCnvReg"  
	 XREF="faceWidth" 
	 YREF="faceWidth" 
	 ZREF="inactiveThickToCnvReg" materialREF="TKRFaceMat" />
    <box name="TKRFaceOutside"  
	 XREF="faceWidth" 
	 YREF="faceWidth" 
	 ZREF="inactiveThickOutside" materialREF="TKRFaceMat" />

    <!-- Make a stack for the bottom tray -->
    <stackZ name="trayBot" >
      <axisPos volume="TKRFaceOutside" />
      <axisPos volume="TKRCoreBottom" />
      <axisPos volume="TKRFaceUpperReg" />
      <axisPos volume="SiLayer" >
	<idField name="fTKRTrayCmp" valueREF="eTKRSiTop" />
      </axisPos>
    </stackZ>

    <!-- Stack for middle no-lead trays -->
    <stackZ name="trayNoConv" >
      <axisPos volume="SiLayer" >
	<idField name="fTKRTrayCmp" valueREF="eTKRSiBottom" />
      </axisPos>
      <axisPos volume="TKRFaceLowerNoCnv" />
      <axisPos volume="TKRCoreReg" />
      <axisPos volume="TKRFaceUpperReg" />
      <axisPos volume="SiLayer" >
	<idField name="fTKRTrayCmp" valueREF="eTKRSiTop" /> 
      </axisPos>
    </stackZ>

    <!-- stack for super-GLAST layers -->
    <stackZ name="traySuper" >
      <axisPos volume="SiLayer" >
	<idField name="fTKRTrayCmp" valueREF="eTKRSiBottom" />
      </axisPos>
      <axisPos volume="TKRBelowCnv" />
      <axisPos volume="convSuper" >
        <idField name="fTKRTrayCmp" valueREF="eTKRCnv" />
      </axisPos>
      <axisPos volume="TKRFaceToCnvSuper" />
      <axisPos volume="TKRCoreReg" />
      <axisPos volume="TKRFaceUpperSuper" />
      <axisPos volume="SiLayer" >
	<idField name="fTKRTrayCmp" valueREF="eTKRSiTop" />
      </axisPos>
    </stackZ>

    <!-- Regular trays other than top -->
    <stackZ name="trayReg" >
      <axisPos volume="SiLayer" >
	<idField name="fTKRTrayCmp" valueREF="eTKRSiBottom" />
      </axisPos>
      <axisPos volume="TKRBelowCnv" />
      <axisPos volume="convReg"  >
        <idField name="fTKRTrayCmp" valueREF="eTKRCnv" />
      </axisPos>
      <axisPos volume="TKRFaceToCnvReg" />
      <axisPos volume="TKRCoreReg" />
      <axisPos volume="TKRFaceUpperReg" />
      <axisPos volume="SiLayer" >
	<idField name="fTKRTrayCmp" valueREF="eTKRSiTop" />
      </axisPos>
    </stackZ>

    <!-- top tray -->
    <stackZ name="trayTop" >
      <axisPos volume="SiLayer" >
	<idField name="fTKRTrayCmp" valueREF="eTKRSiBottom" /> 
      </axisPos>
      <axisPos volume="TKRBelowCnv" />
      <axisPos volume="convReg" >
        <idField name="fTKRTrayCmp" valueREF="eTKRCnv" />
      </axisPos> 
      <axisPos volume="TKRFaceToCnvReg" />
      <axisPos volume="TKRCoreReg" />
      <axisPos volume="TKRFaceOutside" />
    </stackZ>

    <!-- make a tracker by stacking up the trays -->
    <stackZ name="oneTKR" >
      <axisPos volume="trayBot" rotation="90" >
	<idField name="fTKRTray" value="0" />
        <idField name="fMeasure" valueREF="eMeasureY" />
      </axisPos>
      <axisPos volume="trayNoConv" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="1" />
        <idField name="fMeasure" valueREF="eMeasureX" />
      </axisPos>
      <axisPos volume="trayNoConv" rotation="90" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="2" />
        <idField name="fMeasure" valueREF="eMeasureY" />
      </axisPos>
      <axisPos volume="traySuper" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="3" />
        <idField name="fMeasure" valueREF="eMeasureX" />
      </axisPos>
      <axisPos volume="traySuper" rotation="90" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="4" />
        <idField name="fMeasure" valueREF="eMeasureY" />
      </axisPos>
      <axisPos volume="traySuper" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="5" />
        <idField name="fMeasure" valueREF="eMeasureX" />
      </axisPos>
      <axisPos volume="traySuper" rotation="90" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="6" />
        <idField name="fMeasure" valueREF="eMeasureY" />
      </axisPos>
      <axisPos volume="trayReg" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="7" />
        <idField name="fMeasure" valueREF="eMeasureX" />
      </axisPos>
      <axisPos volume="trayReg" rotation="90" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="8" />
        <idField name="fMeasure" valueREF="eMeasureY" />
      </axisPos>
      <axisPos volume="trayReg" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="9" />
        <idField name="fMeasure" valueREF="eMeasureX" />
      </axisPos>
      <axisPos volume="trayReg" rotation="90" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="10" />
        <idField name="fMeasure" valueREF="eMeasureY" />
      </axisPos>
      <axisPos volume="trayReg" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="11" />
        <idField name="fMeasure" valueREF="eMeasureX" />
      </axisPos>
      <axisPos volume="trayReg" rotation="90" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="12" />
        <idField name="fMeasure" valueREF="eMeasureY" />
      </axisPos>
      <axisPos volume="trayReg" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="13" />
        <idField name="fMeasure" valueREF="eMeasureX" />
      </axisPos>
      <axisPos volume="trayReg" rotation="90" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="14" />
        <idField name="fMeasure" valueREF="eMeasureY" />
      </axisPos>
      <axisPos volume="trayReg" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="15" />
        <idField name="fMeasure" valueREF="eMeasureX" />
      </axisPos>
      <axisPos volume="trayReg" rotation="90" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="16" />
        <idField name="fMeasure" valueREF="eMeasureY" />
      </axisPos>
      <axisPos volume="trayReg" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="17" />
        <idField name="fMeasure" valueREF="eMeasureX" />
      </axisPos>
      <axisPos volume="trayTop" rotation="90" gapREF="intertrayGap" >
	<idField name="fTKRTray" value="18" />
        <idField name="fMeasure" valueREF="eMeasureY" />
      </axisPos>

    </stackZ>
